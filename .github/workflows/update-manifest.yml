name: Update Bucket Manifest

on:
  # Run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Trigger when sources.txt changes
  push:
    paths:
      - 'sources.txt'
      - 'scripts/**'

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate manifest
        run: |
          python scripts/generate_manifest.py sources.txt -o manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate manifest
        run: |
          python scripts/validate_manifest.py manifest.json

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet manifest.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Changes detected"
            echo ""
            echo "Diff summary:"
            git diff --stat manifest.json
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Count packages
          PACKAGE_COUNT=$(python -c "import json; print(len(json.load(open('manifest.json'))))")

          git add manifest.json
          git commit -m "chore: Update manifest - $(date -u +%Y-%m-%d)

          - Total packages: $PACKAGE_COUNT
          - Trigger: ${{ github.event_name }}
          - Updated by: GitHub Actions

          ðŸ¤– Automated update"
          git push

      - name: Create summary
        if: always()
        run: |
          PACKAGE_COUNT=$(python -c "import json; print(len(json.load(open('manifest.json'))))" 2>/dev/null || echo "N/A")

          echo "## ðŸ“¦ Manifest Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages**: $PACKAGE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: ${{ steps.changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.changed }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Changes" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 manifest.json --stat 2>/dev/null || echo "No previous commit"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
